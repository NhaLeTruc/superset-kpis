# ================================================================
# GoodNote Analytics Platform - Environment Configuration
# ================================================================
# Copy this file to .env and update with your values
# DO NOT commit .env to version control

# ================================================================
# PostgreSQL Database Configuration
# ================================================================
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_DB=analytics
POSTGRES_USER=analytics_user
POSTGRES_PASSWORD=change_this_password_in_production
POSTGRES_SCHEMA=public

# JDBC Connection String (auto-constructed from above)
# jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}

# ================================================================
# Apache Spark Configuration
# ================================================================

# Spark Master Settings
SPARK_MASTER_HOST=spark-master
SPARK_MASTER_PORT=7077
SPARK_MASTER_WEBUI_PORT=8080

# Spark Master URL for cluster mode (uses Docker service name, not container name)
# Note: SPARK_MASTER_HOST=spark-master is the Docker service name which is correct
# for inter-container communication (container name goodnote-spark-master is for host access)
SPARK_MASTER_URL=spark://${SPARK_MASTER_HOST}:${SPARK_MASTER_PORT}

# Spark Worker Settings
SPARK_WORKER_CORES=4
SPARK_WORKER_MEMORY=4g

# Spark Application Settings
SPARK_DRIVER_MEMORY=4g
SPARK_EXECUTOR_MEMORY=4g
SPARK_EXECUTOR_CORES=4

# Spark SQL Settings
SPARK_SQL_SHUFFLE_PARTITIONS=200
SPARK_SQL_ADAPTIVE_ENABLED=true
SPARK_SQL_AUTOBROADCAST_JOIN_THRESHOLD=104857600  # 100MB

# ================================================================
# Apache Superset Configuration
# ================================================================

# Superset Admin Credentials (CHANGE THESE!)
SUPERSET_ADMIN_USERNAME=admin
SUPERSET_ADMIN_PASSWORD=change_this_password_in_production
SUPERSET_ADMIN_EMAIL=admin@example.com
SUPERSET_ADMIN_FIRSTNAME=Admin
SUPERSET_ADMIN_LASTNAME=User

# Superset Secret Key (generate with: openssl rand -base64 42)
SUPERSET_SECRET_KEY=CHANGE_THIS_TO_A_RANDOM_SECRET_KEY_IN_PRODUCTION

# Superset Database (uses same PostgreSQL)
SUPERSET_DATABASE_URI=postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/superset

# Superset Redis Cache
SUPERSET_REDIS_HOST=redis
SUPERSET_REDIS_PORT=6379
SUPERSET_REDIS_DB=1

# Superset Web Server
SUPERSET_WEBSERVER_PORT=8088
SUPERSET_LOAD_EXAMPLES=no

# ================================================================
# Redis Configuration (for Superset caching)
# ================================================================
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=

# ================================================================
# Data Paths
# ================================================================

# Input Data Paths
DATA_INPUT_INTERACTIONS=/app/data/raw/user_interactions.csv
DATA_INPUT_METADATA=/app/data/raw/user_metadata.csv

# Processed Data Paths
DATA_PROCESSED_ENRICHED=/app/data/processed/enriched_interactions.parquet

# Output Paths
DATA_OUTPUT_METRICS=/app/data/output/metrics

# ================================================================
# Job Configuration
# ================================================================

# ETL Job Settings
ETL_BATCH_SIZE=10000
ETL_NUM_PARTITIONS=4
ETL_WRITE_MODE=overwrite

# Session Analysis Settings
SESSION_TIMEOUT_SECONDS=1800  # 30 minutes
SESSION_BOUNCE_THRESHOLD=1     # Single action = bounce

# Cohort Analysis Settings
COHORT_RETENTION_WEEKS=26      # Track retention for 26 weeks
COHORT_PERIOD=weekly           # weekly or monthly

# Performance Analysis Settings
PERFORMANCE_PERCENTILES=0.5,0.95,0.99
PERFORMANCE_ANOMALY_THRESHOLD=3.0  # Z-score threshold
PERFORMANCE_ANOMALY_SEVERITY_CRITICAL=4.0
PERFORMANCE_ANOMALY_SEVERITY_HIGH=3.5
PERFORMANCE_ANOMALY_SEVERITY_MEDIUM=3.0

# Power Users Settings
POWER_USER_PERCENTILE=0.99     # Top 1%

# ================================================================
# Logging Configuration
# ================================================================
LOG_LEVEL=INFO
LOG_FORMAT=%(asctime)s - %(name)s - %(levelname)s - %(message)s
LOG_FILE_PATH=/app/logs/spark-jobs.log

# ================================================================
# Testing Configuration
# ================================================================
TEST_MODE=false
TEST_SAMPLE_SIZE=1000
PYTEST_TIMEOUT=300  # 5 minutes

# ================================================================
# Production-Specific Settings
# ================================================================
# Uncomment and configure for production deployment

# Security
# SSL_ENABLED=true
# SSL_CERT_PATH=/app/certs/server.crt
# SSL_KEY_PATH=/app/certs/server.key

# Monitoring
# PROMETHEUS_PORT=9090
# GRAFANA_PORT=3000
# SPARK_METRICS_NAMESPACE=goodnote_analytics

# Resource Limits
# MAX_CONCURRENT_JOBS=5
# JOB_TIMEOUT_SECONDS=7200  # 2 hours

# Backup
# BACKUP_ENABLED=true
# BACKUP_SCHEDULE="0 2 * * *"  # Daily at 2 AM
# BACKUP_RETENTION_DAYS=30

# Alerts
# ALERT_EMAIL=alerts@example.com
# SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
# PAGERDUTY_API_KEY=your_pagerduty_api_key

# ================================================================
# Docker Image Versions
# ================================================================
# Spark Image Configuration
SPARK_IMAGE=apache/spark
SPARK_VERSION=3.5.0-python3

# Superset Image Configuration
SUPERSET_IMAGE=apache/superset
SUPERSET_VERSION=latest
SUPERSET_PYTHON_VERSION=3.10

# PostgreSQL Image Configuration
POSTGRES_IMAGE=postgres
POSTGRES_VERSION=15-alpine

# Redis Image Configuration
REDIS_IMAGE=redis
REDIS_VERSION=7-alpine
REDIS_APPENDONLY=yes

# ================================================================
# Superset Advanced Configuration
# ================================================================
# Superset Database Configuration
# Options: sqlite, postgresql
SUPERSET_DB_TYPE=sqlite
# SQLite database path (only used when SUPERSET_DB_TYPE=sqlite)
SUPERSET_DB_PATH=/app/superset_home/superset.db
# If using PostgreSQL for Superset metadata (set SUPERSET_DB_TYPE=postgresql)
SUPERSET_DB_NAME=superset
SUPERSET_DB_HOST=${POSTGRES_HOST}
SUPERSET_DB_PORT=${POSTGRES_PORT}
SUPERSET_DB_USER=${POSTGRES_USER}
SUPERSET_DB_PASSWORD=${POSTGRES_PASSWORD}

# Superset Cache Configuration
SUPERSET_CACHE_DEFAULT_TIMEOUT=300
SUPERSET_DATA_CACHE_TIMEOUT=86400
SUPERSET_CACHE_REDIS_DB=1
SUPERSET_DATA_CACHE_REDIS_DB=2

# Superset Application Settings
SUPERSET_ROW_LIMIT=5000
SUPERSET_SQLLAB_TIMEOUT=300
SUPERSET_WEBSERVER_TIMEOUT=300
SUPERSET_WTF_CSRF_ENABLED=True
SUPERSET_PUBLIC_ROLE_LIKE=Gamma

# ================================================================
# Docker Compose Specific
# ================================================================
COMPOSE_PROJECT_NAME=goodnote-analytics
COMPOSE_FILE=docker-compose.yml

# Container Names
CONTAINER_SPARK_MASTER=goodnote-spark-master
CONTAINER_SPARK_WORKER_1=goodnote-spark-worker-1
CONTAINER_SPARK_WORKER_2=goodnote-spark-worker-2
CONTAINER_POSTGRES=goodnote-postgres
CONTAINER_SUPERSET=goodnote-superset
CONTAINER_REDIS=goodnote-redis

# Network
NETWORK_NAME=goodnote-network

# Volumes
VOLUME_POSTGRES_DATA=postgres_data
VOLUME_SPARK_WORK=spark_work
VOLUME_REDIS_DATA=redis_data
